function Timer(target,action,interval,repeat){var timerIsRunning=false;var t;var fire=function(){target[action].call(target);if(repeat===true){cycle();}};var cycle=function(){if(timerIsRunning){t=setTimeout(function(){fire();},interval);}};this.start=function(){timerIsRunning=true;fire();};this.stop=function(){clearTimeout(t);timerIsRunning=false;};}
function STTabataTimer(delegate){this.sessionPhases={start:0,prepare:1,work:2,rest:3,end:4};this.isRunning=false;this.isActive=false;this.timer=new Timer(this,"fireTimer",1000,true);this.preparationTimeSetting=10;this.workTimeSetting=20;this.restTimeSetting=10;this.cyclesSetting=8;this.tabatasSetting=1;this.sessionPhase=this.sessionPhases.start;this.currentTabata=1;this.currentTime=0;this.totalTime=0;this.currentCycle=1;this.start=function(){if(this.isRunning){return;}if(this.sessionPhase===this.sessionPhases.start){this.sessionPhase=this.calculateNextPhase();}if(this.sessionPhase!==this.sessionPhases.end){this.isRunning=true;this.isActive=true;this.timer.start();}else{this.endSession();}};this.stop=function(){if(this.isRunning){this.timer.stop();this.isRunning=false;}};this.reset=function(){this.stop();this.isActive=false;this.currentTime=0;this.totalTime=0;this.currentCycle=1;this.currentTabata=1;this.sessionPhase=this.sessionPhases.start;};this.calculateNextPhase=function(){switch(this.sessionPhase){case this.sessionPhases.start:if(this.preparationTimeSetting>0){this.sessionPhase=this.sessionPhases.prepare;}else{if(this.workTimeSetting>0){this.sessionPhase=this.sessionPhases.work;}else{if(this.restTimeSetting>0){this.sessionPhase=this.sessionPhases.rest;}else{this.sessionPhase=this.sessionPhases.end;}}}break;case this.sessionPhases.prepare:if(this.workTimeSetting>0){this.sessionPhase=this.sessionPhases.work;}else{if(this.restTimeSetting>0){this.sessionPhase=this.sessionPhases.rest;}else{if(this.currentTabata<this.tabatasSetting){this.currentTabata++;delegate.tabataComplete.call(this);this.currentCycle=1;}else{this.sessionPhase=this.sessionPhases.end;}}}break;case this.sessionPhases.work:if(this.restTimeSetting>0){this.sessionPhase=this.sessionPhases.rest;}else{if(this.currentCycle<this.cyclesSetting){this.currentCycle++;}else{if(this.currentTabata<this.tabatasSetting){this.currentTabata++;delegate.tabataComplete.call(this);this.currentCycle=1;if(this.preparationTimeSetting>0){this.sessionPhase=this.sessionPhases.prepare;}else{this.sessionPhase=this.sessionPhases.work;}}else{this.sessionPhase=this.sessionPhases.end;}}}break;case this.sessionPhases.rest:if(this.currentCycle<this.cyclesSetting){this.currentCycle++;if(this.workTimeSetting>0){this.sessionPhase=this.sessionPhases.work;}}else{if(this.currentTabata<this.tabatasSetting){this.currentTabata++;delegate.tabataComplete.call(this);this.currentCycle=1;if(this.preparationTimeSetting>0){this.sessionPhase=this.sessionPhases.prepare;}else{if(this.workTimeSetting>0){this.sessionPhase=this.sessionPhases.work;}else{if(this.restTimeSetting>0){this.sessionPhase=this.sessionPhases.rest;}else{this.sessionPhase=this.sessionPhases.end;}}}}else{this.sessionPhase=this.sessionPhases.end;}}break;}if(this.sessionPhase===this.sessionPhases.prepare){this.currentTime=this.preparationTimeSetting;}else{if(this.sessionPhase===this.sessionPhases.work){this.currentTime=this.workTimeSetting;}else{if(this.sessionPhase===this.sessionPhases.rest){this.currentTime=this.restTimeSetting;}}}return this.sessionPhase;};this.endSession=function(){this.reset();delegate.sessionEnded.call(this);};this.fireTimer=function(){if(this.currentTime===0){if(this.calculateNextPhase()===this.sessionPhases.end){this.endSession();}}delegate.timerHasFired.call(this);this.totalTime++;this.currentTime--;};}
function STTabataTimerViewControllerNew(){var self=this;var tabatatimer=new STTabataTimer(this);var field="prepare";var labels={};var sounds={};var setValueTimer=null;var setValueIntervals=300;var setValueSpeedThreshold=120;var flashTimer=null;var soundsOn=1;var currentSound=null;var userId=0;var presetId=0;var presetName=labels.tabata;var presetSaveDisabled=true;var isLoggedIn=function(){var cookies=document.cookie.split(";");var cookieKeys=[];var emailFound=0;var passwordFound=0;for(var cookie in cookies){cookieKeys.push(cookies[cookie].split("=")[0]);}for(var i=0;i<cookieKeys.length;i++){if(cookieKeys[i].match(/UserPassword/ig)){passwordFound=1;}if(cookieKeys[i].match(/UserEmail/ig)){emailFound=1;}}return(passwordFound&&emailFound);};var playSound=function(sound){if(!soundsOn){return false;}if(window.HTMLAudioElement){if(currentSound){currentSound.pause();currentSound.currentTime=0;currentSound=null;currentSound=sound;currentSound.play();}else{currentSound=sound;currentSound.play();}}else{var soundContainer=document.getElementById("timerSound");soundContainer.innerHTML='<embed type="audio/mpeg" src="'+sound+'" hidden="true" autostart="true" loop="false" />';}};var startSetValue=function(i){if(field==="prepare"){tabatatimer.preparationTimeSetting+=i;tabatatimer.preparationTimeSetting=Math.min(Math.max(tabatatimer.preparationTimeSetting,0),3599);}else{if(field==="work"){tabatatimer.workTimeSetting+=i;tabatatimer.workTimeSetting=Math.min(Math.max(tabatatimer.workTimeSetting,0),3599);}else{if(field==="rest"){tabatatimer.restTimeSetting+=i;tabatatimer.restTimeSetting=Math.min(Math.max(tabatatimer.restTimeSetting,0),3599);}else{if(field==="cycles"){tabatatimer.cyclesSetting+=i;tabatatimer.cyclesSetting=Math.min(Math.max(tabatatimer.cyclesSetting,1),99);}else{if(field==="tabatas"){tabatatimer.tabatasSetting+=i;tabatatimer.tabatasSetting=Math.min(Math.max(tabatatimer.tabatasSetting,1),99);}}}}}i=(setValueSpeedThreshold<=40)?((i>0)?2:-2):i;i=(setValueSpeedThreshold<=20)?((i>0)?4:-4):i;i=(setValueSpeedThreshold===0)?((i>0)?6:-6):i;setValueTimer=setTimeout(function(){if(setValueSpeedThreshold>0){setValueSpeedThreshold--;}startSetValue(i);},setValueIntervals);setValueIntervals=(setValueIntervals>80)?(setValueIntervals-20):setValueIntervals;presetSaveDisabled=false;changeLayoutState();};var endSetValue=function(){clearTimeout(setValueTimer);setValueTimer=null;setValueIntervals=300;setValueSpeedThreshold=120;};var startFlash=function(el){if($(el).is(":visible")){$(el).hide();}else{$(el).show();}flashTimer=setTimeout(function(){startFlash(el);},500);};var endFlash=function(el){$(el).show();clearTimeout(flashTimer);flashTimer=null;};var totalWorkoutTime=function(){var cycle=(tabatatimer.workTimeSetting+tabatatimer.restTimeSetting);var tabata=(cycle*tabatatimer.cyclesSetting)+tabatatimer.preparationTimeSetting;return(tabata*tabatatimer.tabatasSetting);};var convertDouble=function(num){return(num<10?"0"+num:num);};var convertTimeFormat=function(num){var hrs=Math.floor(num/3600);var mins=Math.floor((num%3600)/60);var secs=num%60;return(hrs>0?hrs+":":"")+(mins<10?"0":"")+mins+":"+(secs<10?"0":"")+secs;};var setField=function(f){field=f;if(field==="prepare"){$("#timerIndicatorArrow").css("top","34px");}else{if(field==="work"){$("#timerIndicatorArrow").css("top","96px");}else{if(field==="rest"){$("#timerIndicatorArrow").css("top","158px");}else{if(field==="cycles"){$("#timerIndicatorArrow").css("top","220px");}else{if(field==="tabatas"){$("#timerIndicatorArrow").css("top","282px");}}}}}};var resetField=function(){if(field==="prepare"){tabatatimer.preparationTimeSetting=0;}else{if(field==="work"){tabatatimer.workTimeSetting=0;}else{if(field==="rest"){tabatatimer.restTimeSetting=0;}else{if(field==="cycles"){tabatatimer.cyclesSetting=1;}else{if(field==="tabatas"){tabatatimer.tabatasSetting=1;}}}}}presetSaveDisabled=false;changeLayoutState();};var toggleSoundsOn=function(){soundsOn=(soundsOn?0:1);if(soundsOn){playSound(sounds.soundOn);}$("#timerPresetToolbarSoundOn a").text(labels.sound+": "+(soundsOn?labels.on:labels.off));presetSaveDisabled=false;changeLayoutState();return false;};var changeLayoutState=function(){switch(parseInt(tabatatimer.sessionPhase)){case 1:$("#timerClockFrameValue").html(convertTimeFormat(tabatatimer.currentTime));$("#timerClockFrameValue").css("font-size","157px");$("#timerClockFrame").removeClass().addClass("prepare");$("#timerClockFrameLabel").text(labels.prepare);$("#timerSaveActionValue").addClass("disabled");if(tabatatimer.currentTime===3){if(tabatatimer.preparationTimeSetting>4){playSound(sounds.warning);}}break;case 2:$("#timerClockFrameValue").html(convertTimeFormat(tabatatimer.currentTime));$("#timerClockFrameValue").css("font-size","157px");$("#timerClockFrame").removeClass().addClass("work");$("#timerClockFrameLabel").text(labels.work);$("#timerSaveActionValue").addClass("disabled");if(tabatatimer.currentTime===3){if(tabatatimer.workTimeSetting>4){playSound(sounds.warning);}}if(tabatatimer.workTimeSetting===tabatatimer.currentTime){playSound(sounds.work);}break;case 3:$("#timerClockFrameValue").html(convertTimeFormat(tabatatimer.currentTime));$("#timerClockFrameValue").css("font-size","157px");$("#timerClockFrame").removeClass().addClass("rest");$("#timerClockFrameLabel").text(labels.rest);$("#timerSaveActionValue").addClass("disabled");if(tabatatimer.currentTime===3){if(tabatatimer.restTimeSetting>4){playSound(sounds.warning);}}if(tabatatimer.restTimeSetting===tabatatimer.currentTime){playSound(sounds.rest);}break;default:$("#timerClockFrameValue").html(convertTimeFormat(totalWorkoutTime()));$("#timerClockFrameValue").css("font-size","157px");if(totalWorkoutTime()>3600){$("#timerClockFrameValue").css("font-size","145px");}if(totalWorkoutTime()>36000){$("#timerClockFrameValue").css("font-size","120px");}if(totalWorkoutTime()>3600000){$("#timerClockFrameValue").css("font-size","100px");}$("#timerClockFrame").removeClass().addClass("default");$("#timerClockFrameLabel").text(self.getValues().presetName);if(presetSaveDisabled||(userId===0)){$("#timerSaveActionValue").addClass("disabled");}else{$("#timerSaveActionValue").removeClass("disabled");}break;}$("#timerSetPrepTimeValue").val(convertTimeFormat(tabatatimer.preparationTimeSetting));$("#timerSetWorkTimeValue").val(convertTimeFormat(tabatatimer.workTimeSetting));$("#timerSetRestTimeValue").val(convertTimeFormat(tabatatimer.restTimeSetting));$("#timerSetCyclesValue").val(convertDouble(tabatatimer.cyclesSetting));$("#timerSetTabatasValue").val(convertDouble(tabatatimer.tabatasSetting));$("#timerPresetToolbarShowList a").text(self.getValues().presetName);$("#timerPresetToolbarSoundOn a").text(labels.sound+": "+(soundsOn?labels.on:labels.off));$("#timerCyclesFrameValue").text(convertDouble(tabatatimer.cyclesSetting-tabatatimer.currentCycle+1));$("#timerTabatasFrameValue").text(convertDouble(tabatatimer.tabatasSetting-tabatatimer.currentTabata+1));return false;};var startButtonPushed=function(){if(totalWorkoutTime()>0){tabatatimer.start();playSound(sounds.startingSession);$("#timerControls").hide();$("#timerResetButton").show();$("#timerPauseButton").show();$("#timerStartButton").hide();$("#timerIndicatorArrow").hide();}};var stopButtonPushed=function(){if(tabatatimer.isRunning){tabatatimer.stop();playSound(sounds.pausingSession);$("#timerPauseButton").text(labels.resume);$("#timerPauseButton").removeClass().addClass("timerBigButtonSelected");startFlash("#timerClockFrameValue");}else{tabatatimer.start();playSound(sounds.startingSession);$("#timerPauseButton").text(labels.pause);$("#timerPauseButton").removeClass().addClass("timerBigButton");endFlash("#timerClockFrameValue");}};var resetButtonPushed=function(){if(!tabatatimer.isRunning){$("#timerPauseButton").text(labels.pause);$("#timerPauseButton").removeClass().addClass("timerBigButton");endFlash("#timerClockFrameValue");}tabatatimer.endSession();playSound(sounds.stoppingSession);};this.timerHasFired=function(){changeLayoutState();};this.sessionEnded=function(){playSound(sounds.sessionComplete);$("#timerControls").fadeIn("fast");$("#timerResetButton").hide();$("#timerPauseButton").hide();$("#timerStartButton").show();$("#timerIndicatorArrow").show();changeLayoutState();};this.tabataComplete=function(){playSound(sounds.tabataComplete);};this.callChangeLayoutState=function(activePresetId){$("#timerClockFrameValue").hide();$("#timerCyclesFrameValue").hide();$("#timerTabatasFrameValue").hide();$("#timerClockFrameLabel").hide();$("#timerPresetToolbarShowList a").hide();$("#timerSaveActionValue").attr("rel",activePresetId);$("#timerSaveAsActionValue").attr("rel",activePresetId);$("#timerLoadActionValue").attr("rel",activePresetId);$("#timerPresetToolbarShowList a").attr("rel",activePresetId);presetSaveDisabled=true;changeLayoutState();$("#timerClockFrameValue").fadeIn("slow");$("#timerCyclesFrameValue").fadeIn("slow");$("#timerTabatasFrameValue").fadeIn("slow");$("#timerClockFrameLabel").fadeIn("slow");$("#timerPresetToolbarShowList a").fadeIn("slow");};this.setValues=function(values){userId=(values.userId?values.userId:userId);presetId=(values.presetId?values.presetId:presetId);presetName=(values.presetName?values.presetName:labels.tabata);tabatatimer.preparationTimeSetting=(values.prep?values.prep:tabatatimer.preparationTimeSetting);tabatatimer.workTimeSetting=(values.work?values.work:tabatatimer.workTimeSetting);tabatatimer.restTimeSetting=(values.rest?values.rest:tabatatimer.restTimeSetting);tabatatimer.cyclesSetting=(values.cycles?values.cycles:tabatatimer.cyclesSetting);tabatatimer.tabatasSetting=(values.tabatas?values.tabatas:tabatatimer.tabatasSetting);soundsOn=values.soundsOn;};this.getValues=function(){var values={userId:userId,presetId:presetId,presetName:presetName,prep:tabatatimer.preparationTimeSetting,work:tabatatimer.workTimeSetting,rest:tabatatimer.restTimeSetting,cycles:tabatatimer.cyclesSetting,tabatas:tabatatimer.tabatasSetting,soundsOn:soundsOn};return values;};this.setLabels=function(obj){labels=obj;};this.setSounds=function(obj){sounds=obj;};this.loadSounds=function(callback){var i=0;var soundsLength=0;for(var sound in sounds){if(sounds.hasOwnProperty(sound)){soundsLength++;}}$.each(sounds,function(soundName,soundFile){if(window.HTMLAudioElement){var url="";sounds[soundName]=new Audio();if(sounds[soundName].canPlayType("audio/ogg")){url="media/"+soundFile+".ogg";}else{if(sounds[soundName].canPlayType("audio/mpeg")){url="media/"+soundFile+".mp3";}}$.get(url,function(){sounds[soundName].src=url;sounds[soundName].loop=false;sounds[soundName].autoplay=false;sounds[soundName].load();});}else{sounds[soundName]="media/"+soundFile+".mp3";}i++;if(i===soundsLength){callback(true);}});};this.drawTimer=function(el){$(el).empty();$(el).html('<div id="timerWrap"></div>');$("#timerWrap").append('<span id="timerSound"></span>').append('<ul id="timerPresetToolbarWrap"></ul>').append('<div id="timerControlsWrap"></div>').append('<div id="timerIndicator"><div id="timerIndicatorArrow"></div></div>').append('<div id="timerClockWrap"></div>');$("#timerPresetToolbarWrap").append('<li id="timerPresetToolbarLabel"></li>').append('<li id="timerPresetToolbarShowList"><a href="#" rel="'+presetId+'"></a></li>').append('<li id="timerPresetToolbarAdd"><a href="#"></a></li>').append('<li id="timerPresetToolbarSoundOn"><a href="#"></a></li>');$("#timerControlsWrap").append('<ul id="timerControls"></ul>').append('<a class="timerBigButton" id="timerResetButton" style="display:none;"></a>').append('<a class="timerBigButton" id="timerPauseButton" style="display:none;"></a>').append('<a class="timerBigButton" id="timerStartButton"></a>');$("#timerControls").append('<li id="timerSetPrepTime"><input type="text" class="field" id="timerSetPrepTimeValue" readonly /><span class="label" id="timerSetPrepTimeLabel"></span></li>').append('<li id="timerSetWorkTime"><input type="text" class="field" id="timerSetWorkTimeValue" readonly /><span class="label" id="timerSetWorkTimeLabel"></span></li>').append('<li id="timerSetRestTime"><input type="text" class="field" id="timerSetRestTimeValue" readonly /><span class="label" id="timerSetRestTimeLabel"></span></li>').append('<li id="timerSetCycles"><input type="text" class="field" id="timerSetCyclesValue" readonly /><span class="label" id="timerSetCyclesLabel"></span></li>').append('<li id="timerSetTabatas"><input type="text" class="field" id="timerSetTabatasValue" readonly /><span class="label" id="timerSetTabatasLabel"></span></li>').append('<li id="timerChangeSettingValue"></li>');$("#timerChangeSettingValue").append('<a class="timerSmallButton" id="timerDecreaseSettingValue">-</a>').append('<a class="timerSmallButton" id="timerIncreaseSettingValue">+</a>');$("#timerClockWrap").append('<div id="timerClockFrame"><span class="label" id="timerClockFrameLabel"></span><span class="value" id="timerClockFrameValue"></span></div>').append('<div id="timerCyclesFrame"><span class="value" id="timerCyclesFrameValue"></span><span class="label" id="timerCyclesFrameLabel"></span></div>').append('<div id="timerTabatasFrame"><span class="value" id="timerTabatasFrameValue"></span><span class="label" id="timerTabatasFrameLabel"></span></div>');$("#timerPresetToolbarLabel").text(labels.preset+":");$("#timerResetButton").text(labels.stop);$("#timerPauseButton").text(labels.pause);$("#timerStartButton").text(labels.start);$("#timerSetPrepTimeLabel").text(labels.prepare);$("#timerSetWorkTimeLabel").text(labels.work);$("#timerSetRestTimeLabel").text(labels.rest);$("#timerSetCyclesLabel").text(labels.cyclesl);$("#timerSetTabatasLabel").text(labels.tabatasl);$("#timerSetSoundLabel").text(labels.sound);$("#timerCyclesFrameLabel").text(labels.cycles);$("#timerTabatasFrameLabel").text(labels.tabatas);changeLayoutState();var autosavePreset=function(){if(isLoggedIn()){savePreset(self,function(data){changeLayoutState();});}return false;};var loadPresetButtonPushed=function(el){var activePresetId=$(el).attr("rel");getLoadPresetPopup(self,activePresetId);changeLayoutState();return false;};var saveasPresetButtonPushed=function(el){getSaveAsPresetPopup(self);return false;};$("#timerSetPrepTime").click(function(){setField("prepare");return false;}).dblclick(function(){resetField();autosavePreset();return false;});$("#timerSetWorkTime").click(function(){setField("work");return false;}).dblclick(function(){resetField();autosavePreset();return false;});$("#timerSetRestTime").click(function(){setField("rest");return false;}).dblclick(function(){resetField();autosavePreset();return false;});$("#timerSetCycles").click(function(){setField("cycles");return false;}).dblclick(function(){resetField();autosavePreset();return false;});$("#timerSetTabatas").click(function(){setField("tabatas");return false;}).dblclick(function(){resetField();autosavePreset();return false;});$("#timerIncreaseSettingValue").mousedown(function(){startSetValue(1);return false;}).mouseup(function(){endSetValue();autosavePreset();return false;}).mouseout(function(){endSetValue();autosavePreset();return false;});$("#timerDecreaseSettingValue").mousedown(function(){startSetValue(-1);return false;}).mouseup(function(){endSetValue();autosavePreset();return false;}).mouseout(function(){endSetValue();autosavePreset();return false;});$("#timerPresetToolbarShowList a").click(function(){if(tabatatimer.isActive){return false;}loadPresetButtonPushed(this);return false;});$("#timerPresetToolbarAdd a").click(function(){if(tabatatimer.isActive){return false;}saveasPresetButtonPushed(this);return false;});$("#timerPresetToolbarSoundOn a").click(function(){autosavePreset();toggleSoundsOn();return false;});$("#timerResetButton").click(function(){resetButtonPushed();return false;});$("#timerPauseButton").click(function(){stopButtonPushed();return false;});$("#timerStartButton").click(function(){startButtonPushed();return false;});};}